<script setup>
import { toRefs, computed, useSlots, ref, reactive } from "vue";
import VueCountdown from "@chenfengyuan/vue-countdown";
import useItemStore from "@/stores/item";
import { useRouter } from "vue-router";
import "../assets/css/itemcard.css";

const isImageLoaded = ref(false);
const props = defineProps([
  "id",
  "tileItem",
  "isSelectedToken",
  "refContainer",
]);
const itemStore = useItemStore();
const router = useRouter();
const { tileItem } = toRefs(props);
const item = tileItem.value.item;

const diff = (end_date) => {
  const miliDiff = new Date(end_date).getTime() - new Date().getTime();
  const seconds = Math.floor(miliDiff);
  if (seconds < 0) return 0;
  return seconds;
};

const onImageClicked = async () => {
  router.push(`/items`);
  itemStore.selectItem(item.id);
};

const onImageLoad = () => (isImageLoaded.value = true);

const isOnSale = (soldAmount, totalAmount, start_date, end_date) => {
  if (!start_date) {
    if (totalAmount === -1) {
      return true;
    } else if (totalAmount - soldAmount > 0) {
      return true;
    } else {
      return false;
    }
  } else {
    if (totalAmount === -1 && diff(end_date) > 0) {
      return true;
    } else if (totalAmount - soldAmount > 0 && diff(end_date) > 0) {
      return true;
    } else {
      return false;
    }
  }
};

const pad = (num, size) => {
  num = num.toString();
  while (num.length < size) num = "0" + num;
  return num;
};
</script>

<template>
  <div
    class="relative text-left transition bg-black/10 bg-gradient-to-b from-white/10 to-black/10 rounded-[8px]"
    @click="onImageClicked"
  >
    <div
      v-if="!isImageLoaded"
      class="absolute top-0 left-0 z-10 flex items-center justify-center w-full h-full text-left backdrop-blur-sm"
    >
      <Spinner class="w-8 h-8" />
    </div>

    <div class="relative h-full">
      <div
        class="badge-promo"
        :class="
          !isOnSale(
            item?.sold_amount,
            item?.quantity,
            item?.start_date,
            item?.end_date
          ) && `before:!bg-[#3e3e3e] after:!bg-[#707070]`
        "
      >
        <div v-if="!item.associated_nft_id" class="glow-button"></div>
        <span class="badge-promo-content black-emboss">
          {{ `${item.type.name} #${pad(item.id, 3)} - ${item.color.name}` }}
        </span>
      </div>

      <Transition name="fade" class="relative">
        <div class="relative">
          <div class="item-inset-shadow">
            <img
              :src="item.image_url"
              class="w-full aspect-[9/6]"
              @load="onImageLoad"
              v-show="isImageLoaded"
            />
          </div>
        </div>
      </Transition>
      <div
        class="absolute bottom-0 bg-gradient-to-b from-[#3e3e3e40] via-[#3e3e3e80] to-[#000000d6] w-full h-full image-border hover:border-[#f5c353]"
      ></div>

      <div class="absolute bottom-0 w-full gap-4 px-3 py-3 backdrop-blur-sm">
        <div class="text-center w-full">
          <div>
            <vue-countdown
              :time="diff(item?.start_date, item?.end_date)"
              v-slot="{ days, hours, minutes, seconds }"
            >
              {{ days }} : {{ hours }} : {{ minutes }} : {{ seconds }}
            </vue-countdown>
          </div>
          <div
            class="font-semibold leading-tight text-[#d5d5d5] w-full break-words"
            :style="{ color: `${item.rarity.color}` }"
            :title="item.rarity.name"
          >
            {{ item?.name }}
          </div>
          <div
            class="font-semibold leading-tight text-[#dbc425] flex items-center justify-center mt-1"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            &nbsp;
            <span
              class="text-[0.8rem]"
              v-if="item?.reduction_rate === 0 || item.reduction_rate === null"
              >{{ item?.price }}
              {{ item?.currency_type === "0" ? "ETH" : "EQY" }}
            </span>
            <span class="text-[0.8rem]" v-else>
              <del class="text-[#aaa]">{{ item?.price }}</del> /
              <span class="">{{
                calDiscountRate(item?.price, item?.reduction_rate)
              }}</span>
              {{ item?.currency_type === "0" ? "ETH" : "EQY" }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
